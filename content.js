///
/// 豆包的发送消息元素
///
/*
<div className="container-PvPoAn">
    <div className="item-kDun2N">
        <div className="container-SrVXPg chrome70-container"
             style="--right-side-width: 0px; --center-content-max-width: 848px;">
            <div className="inner-Qo5lJS inner-item-w21SQO" data-target-id="message-box-target-id"
                 data-testid="union_message">
                <div data-testid="message-block-container" data-ui-version="samantha"
                     className="message-block-container-PggqdK" style="--message-block-container-inline-width: 655px;">
                    <div data-testid="send_message"
                         className="flex flex-row w-full justify-end w-full max-w-full s-font-base text-s-color-text-secondary p-0 rounded-s-radius-s bg-transparent data-[attr=select-mode]:-mt-10 data-[attr=select-mode]:py-10 data-[attr=select-mode]:px-16 data-[attr=select-mode]:sm:p-10 data-[attr=select-mode]:hover:bg-s-color-bg-base data-[attr=select-mode]:hover:rounded-s-radius-xs data-[attr=select-mode]:has-[:checked]:bg-s-color-bg-trans data-[attr=select-mode]:has-[:checked]:rounded-s-radius-xs data-[attr=select-mode]:pointer-events-none">
                        <div className="flex flex-col flex-grow max-w-full min-w-0">
                            <div data-testid="message_content" data-message-id="36865762923923458"
                                 className="flex-row flex w-full justify-end">
                                <div className="flex max-w-full flex-col gap-8">
                                    <div data-render-engine="node" data-plugin-identifier="block_type:10000"
                                         className="flex justify-end">
                                        <div data-testid="message_text_content"
                                             className="container-QQkdo4 bg-s-color-bg-trans rounded-s-radius-s text-s-color-text-secondary s-font-base sm:text-15 max-w-450 px-16 py-9 w-fit min-w-0 !text-[length:var(--message-send-text-content-font-size,16px)]"
                                             id="doubao-user-msg-1769742871850-me8x">这里是用户发送的文本
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="select-none" data-foundation-type="send-message-action-bar">
                                <div
                                    className="flex flex-col justify-end h-40 w-full select-none opacity-0 pointer-events-none"
                                    data-testid="message_action_bar">
                                    <div
                                        className="message-action-bar-raqbg0 flex flex-row w-full group relative -right-10 justify-end">
                                        <span data-button-mode="max" className="hidden"></span>
                                        <div
                                            className="bp5-overflow-list message-action-button-main flex w-fit min-w-0 items-center gap-10 self-center">
                                            <button className="
        flex w-fit cursor-pointer rounded-4 border-0 bg-transparent p-0
        hover:bg-s-color-bg-trans-primary
        disabled:pointer-events-none disabled:cursor-not-allowed
        disabled:opacity-30
      " data-testid="message_action_copy" tabIndex="0" aria-describedby="529dnii" data-popupid="529dnii"><span
                                                className="
            flex h-24 w-24 items-center justify-center
            text-s-color-text-tertiary
          "><span role="img" className="semi-icon semi-icon-default"><svg xmlns="http://www.w3.org/2000/svg" width="1em"
                                                                          height="1em" fill="none" viewBox="0 0 24 24"><path
                                                fill="currentColor" fill-rule="evenodd"
                                                d="M21 3.5V17a2 2 0 0 1-2 2h-2v-2h2V3.5H9v2h5.857c1.184 0 2.143.895 2.143 2v13c0 1.105-.96 2-2.143 2H5.143C3.959 22.5 3 21.605 3 20.5v-13c0-1.105.96-2 2.143-2H7v-2a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2m-6.143 4H5.143v13h9.714z"
                                                clip-rule="evenodd"></path></svg></span></span></button>
                                            <button className="
        flex w-fit cursor-pointer rounded-4 border-0 bg-transparent p-0
        hover:bg-s-color-bg-trans-primary
        disabled:pointer-events-none disabled:cursor-not-allowed
        disabled:opacity-30
      " data-testid="message_action_share" tabIndex="0" aria-describedby="oozz5kt" data-popupid="oozz5kt"><span
                                                className="
            flex h-24 w-24 items-center justify-center
            text-s-color-text-tertiary
          "><span role="img" className="semi-icon semi-icon-default text-16 p-2"
                  data-testid="message_action_icon_share"><svg xmlns="http://www.w3.org/2000/svg" width="1em"
                                                               height="1em" fill="none" viewBox="0 0 24 24"><path
                                                fill="currentColor" fill-rule="evenodd"
                                                d="M12.719 13.833v3.64l7.641-5.872.264-.203-.264-.203-7.641-5.884v3.185l-1.688.302c-4.095.732-6.716 3.722-7.625 7.786q.668-.605 1.457-1.078c1.647-.983 3.551-1.433 5.693-1.553zM10.67 6.781c-6.405 1.144-9.6 6.714-9.669 12.991a19 19 0 0 0 .006.713c.012.458.018.686.062.806a.767.767 0 0 0 1.248.29c.093-.087.23-.346.502-.865a12 12 0 0 1 .232-.422c1.307-2.267 3.043-3.526 5.571-4.043.632-.13 1.312-.213 2.048-.254v2.512c0 .89 0 1.335.155 1.583.206.331.582.517.97.478.291-.029.643-.3 1.348-.84l8.465-6.506c.717-.55 1.075-.826 1.234-1.147.21-.428.21-.93 0-1.357-.157-.321-.516-.597-1.232-1.148l-8.466-6.52c-.705-.542-1.057-.813-1.348-.842a1.02 1.02 0 0 0-.971.478c-.155.248-.155.692-.155 1.58z"
                                                clip-rule="evenodd"></path></svg></span></span><span className="
            h-24 text-sm leading-24 font-medium text-s-color-text-tertiary
            group-has-[[data-button-mode='max']]:hidden
            last:pr-4
          ">分享</span></button>
                                            <div>
                                                <button className="
        flex w-fit cursor-pointer rounded-4 border-0 bg-transparent p-0
        hover:bg-s-color-bg-trans-primary
        disabled:pointer-events-none disabled:cursor-not-allowed
        disabled:opacity-30
      " data-testid="message_action_more" tabIndex="0" aria-describedby="bj6mhee" data-popupid="bj6mhee"><span
                                                    className="
            flex h-24 w-24 items-center justify-center
            text-s-color-text-tertiary
          "><span role="img" className="semi-icon semi-icon-default"><svg xmlns="http://www.w3.org/2000/svg" width="1em"
                                                                          height="1em" fill="none" viewBox="0 0 24 24"><path
                                                    fill="currentColor"
                                                    d="M5.5 11.75a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0M13.725 11.75a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0M22 11.75a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0"></path></svg></span></span>
                                                </button>
                                            </div>
                                            <div className="bp5-overflow-list-spacer"></div>
                                        </div>
                                        <div className="
              mr-12 hidden h-12 w-0 items-center self-center rounded-[0.5px]
              border-[0.5px] border-solid
              border-[var(--s-color-border-secondary)]
              first:hidden
              last:hidden
              [&amp;:has(+.message-action-button-expand)]:block
            "></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

*/

///
/// 核心是匹配规则data-testid="message_text_content"
/// 但是由于豆包的回复也是data-testid="message_text_content"
/// 所以匹配上层容器，data-testid="send-message
///

console.log('【豆包插件】代码开始执行 → 时间：', new Date().toLocaleTimeString());


let processedMessageIds = new Set();
let messageListContent = null;
let chatId = null;
const BASE_SELECTOR = '[data-testid="message_text_content"]';
const SEND_SELECTOR = '[data-testid="send_message"]';


// ========== 步骤1：创建按钮（强制样式，不被遮挡） ==========
function createBtn() {
    console.log('【豆包插件】开始创建按钮');
    const btn = document.createElement('button');
    btn.id = 'doubao-message-btn';
    btn.innerText = '我的消息';
    btn.style.cssText = `
    position: fixed !important;
    top: 50px !important;
    right: 20px !important;
    z-index: 999999 !important;
    padding: 10px 20px !important;
    background: #e63946 !important;
    color: white !important;
    border: none !important;
    border-radius: 6px !important;
    cursor: pointer !important;
    font-size: 14px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
  `;
    document.body.appendChild(btn);
    console.log('【豆包插件】按钮创建完成 → 是否存在：', !!document.getElementById('doubao-message-btn'));
    return btn;
}

// ========== 步骤2：创建列表容器（优化样式） ==========
function createList() {
    console.log('【豆包插件】开始创建列表容器');
    const container = document.createElement('div');
    container.id = 'message-list-container';
    container.style.cssText = `
    display: none !important;
    position: fixed !important;
    top: 100px !important;
    right: 20px !important;
    z-index: 999998 !important;
    width: 380px !important;
    max-height: 550px !important;
    background: white !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
    border-radius: 8px !important;
    padding: 12px !important;
    overflow-y: auto !important;
  `;
    const content = document.createElement('div');
    content.id = 'message-list-content';
    container.appendChild(content);
    document.body.appendChild(container);
    messageListContent = content;
    console.log('【豆包插件】列表容器创建完成 → 是否存在：', !!messageListContent);
    return container;
}

// ========== 步骤3：核心：提取消息（双重过滤，仅保留用户消息） ==========
function getUserMessages() {
    console.log('【豆包插件】开始提取消息 → 基础选择器：', BASE_SELECTOR);
    const allElements = document.querySelectorAll(BASE_SELECTOR);
    console.log('【豆包插件】找到带共用testid的元素总数：', allElements.length);

    const userMsgElements = Array.from(allElements).filter(el => {
        return el.closest(SEND_SELECTOR);
    });

    console.log('【豆包插件】过滤后仅保留用户消息数量：', userMsgElements.length);
    return userMsgElements;
}

// 加载历史聊天记录
function loadHistoryMsg() {
    console.log('【豆包插件】开始加载历史用户消息');
    if (!messageListContent) {
        console.error('【豆包插件】加载失败 → 列表容器不存在');
        return;
    }
    messageListContent.innerHTML = '';

    const userMsgs = getUserMessages();
    if (userMsgs.length === 0) {
        messageListContent.innerHTML = '<div style="text-align:center;padding:30px 0;color:#999;font-size:14px;">暂无用户发送的消息</div>';
        return;
    }

    userMsgs.forEach((msgEl, index) => {
        addMsgToList(msgEl, index + 1);
    });
    console.log('【豆包插件】历史用户消息加载完成 → 已处理数量：', processedMessageIds.size);
}

// ========== 步骤5：添加单条用户消息到列表（支持跳转+高亮） ==========
function addMsgToList(msgEl, index) {
    // 生成唯一ID，避免重复
    const msgId = `doubao-user-msg-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
    if (processedMessageIds.has(msgId)) return;

    // 给用户消息元素添加唯一ID（用于跳转）
    msgEl.id = msgId;
    processedMessageIds.add(msgId);

    // 提取文本并截断（过长时省略）
    const rawText = msgEl.textContent.trim();
    const showText = rawText.length > 45 ? rawText.slice(0, 45) + '...' : rawText;

    // 创建列表项
    const item = document.createElement('div');
    item.style.cssText = `
    padding: 10px 8px;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    font-size: 14px;
    line-height: 1.5;
    color: #333;
    border-radius: 4px;
    margin-bottom: 4px;
  `;
    item.innerHTML = `
    <span style="display:inline-block;width:22px;height:22px;line-height:22px;text-align:center;background:#f0f0f0;color:#666;border-radius:50%;margin-right:10px;font-size:12px;">${index}</span>
    <span>${showText}</span>
  `;

    // 鼠标悬浮效果
    item.onmouseover = () => {
        item.style.background = '#f8f9fa';
    };
    item.onmouseout = () => {
        item.style.background = '';
    };

    // 点击跳转至对应消息位置 + 高亮
    item.onclick = function (e) {
        e.stopPropagation();
        console.log('【豆包插件】点击列表项 → 跳转到用户消息ID：', msgId);
        const targetMsg = document.getElementById(msgId);
        if (targetMsg) {
            // 平滑滚动到视图中央
            targetMsg.scrollIntoView({behavior: 'smooth', block: 'center'});
            // 高亮提示（3秒后恢复）
            targetMsg.style.background = '#fffbeb !important';
            targetMsg.style.borderRadius = '4px !important';
            setTimeout(() => {
                targetMsg.style.background = '';
                targetMsg.style.borderRadius = '';
            }, 3000);
        } else {
            console.error('【豆包插件】跳转失败 → 未找到用户消息ID：', msgId);
        }
    };

    // 追加到列表
    messageListContent.appendChild(item);
}

// ========== 步骤6：监听新消息（仅捕获新增的用户消息） ==========
function watchNewMsg() {
    console.log('【豆包插件】开始监听新增用户消息');
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.addedNodes.length === 0) return;

            // 遍历所有新增节点
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType !== 1) return; // 仅处理元素节点

                // 查找新增节点中是否有用户消息（带共用testid）
                const newMsgEl = node.querySelector(BASE_SELECTOR) || (node.matches(BASE_SELECTOR) ? node : null);
                if (!newMsgEl) return;

                if (newMsgEl.closest(SEND_SELECTOR) && !processedMessageIds.has(newMsgEl.id)) {
                    console.log('【豆包插件】捕获到新增用户消息 ✅');
                    const newIndex = processedMessageIds.size + 1;
                    addMsgToList(newMsgEl, newIndex);
                }
            });
        });
    });


    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: false,
        characterData: false
    });
    console.log('【豆包插件】新增用户消息监听已启动');
}

// ========== 主入口：页面完全加载后初始化所有逻辑 ==========
window.onload = function () {
    console.log('【豆包插件】页面完全加载 → 开始初始化插件');

    // 创建按钮和列表
    const btn = createBtn();
    const listContainer = createList();

    // 按钮点击：显示/隐藏列表 + 刷新历史消息（兜底）
    btn.onclick = function (e) {
        e.stopPropagation();
        const isHidden = listContainer.style.display === 'none';
        if (isHidden) {
            listContainer.style.display = 'block';
            let url = window.location.href;
            let chat = url.substring(url.lastIndexOf('/') + 1);
            if (chat !== chatId) {
                loadHistoryMsg();
            }
        } else {
            listContainer.style.display = 'none';
        }
    };

    // 点击页面其他区域隐藏列表（修复冒泡：不影响列表项点击）
    document.addEventListener('click', function (e) {
        if (e.target !== btn && !listContainer.contains(e.target)) {
            listContainer.style.display = 'none';
        }
    });

    // // 初始加载历史用户消息
    // loadHistoryMsg();
    // let url = window.location.href;
    // chatId = url.substring(url.lastIndexOf('/') + 1);
    // 启动新消息监听
    watchNewMsg();

    console.log('【豆包插件】插件初始化全部完成 ✅✅✅');
};